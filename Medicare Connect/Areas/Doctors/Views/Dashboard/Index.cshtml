@using Medicare_Connect.Areas.Patients.Models
@using Medicare_Connect.Areas.Patients.Services
@{
    ViewData["Title"] = "Doctor Dashboard";

    // Pull appointments from the shared in-memory store via AppointmentStore API
    var all = AppointmentStore.GetAllByPatientKey().SelectMany(kv => kv.Value).ToList();

    string NormalizeName(string? n)
    {
        if (string.IsNullOrWhiteSpace(n)) return string.Empty;
        var x = n.Trim();
        if (x.StartsWith("Dr.", System.StringComparison.OrdinalIgnoreCase)) x = x.Substring(3);
        else if (x.StartsWith("Dr ", System.StringComparison.OrdinalIgnoreCase)) x = x.Substring(3);
        else if (x.StartsWith("Doctor ", System.StringComparison.OrdinalIgnoreCase)) x = x.Substring(7);
        return x.Trim().ToLowerInvariant();
    }

    var doctorName = User.Claims.FirstOrDefault(c => c.Type == "FullName")?.Value ?? (User.Identity?.Name ?? "");
    var mine = all.Where(a => NormalizeName(a.DoctorName) == NormalizeName(doctorName)).ToList();
    var upcoming = mine.Where(a => a.AppointmentDate >= DateTime.Now && a.Status == AppointmentStatus.Booked)
                       .OrderBy(a => a.AppointmentDate)
                       .Take(5)
                       .ToList();
    var today = mine.Where(a => a.AppointmentDate.Date == DateTime.Today && a.Status == AppointmentStatus.Booked).Count();
    var completedThisWeek = mine.Where(a => a.Status == AppointmentStatus.Completed && a.AppointmentDate >= DateTime.Today.AddDays(-7)).Count();
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Sawubona Dokotela, @doctorName</h1>
            <p class="text-muted mb-0">Overview of your schedule and recent activity</p>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card dashboard-card border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-muted mb-0">Today's Appointments</h6>
                        <i class="bi bi-calendar2-day text-primary"></i>
                    </div>
                    <h2 class="mb-0">@today</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card dashboard-card border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-muted mb-0">Upcoming (next 5)</h6>
                        <i class="bi bi-clock-history text-primary"></i>
                    </div>
                    <h2 class="mb-0">@upcoming.Count</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card dashboard-card border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-muted mb-0">Completed (7 days)</h6>
                        <i class="bi bi-check2-circle text-success"></i>
                    </div>
                    <h2 class="mb-0">@completedThisWeek</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="card dashboard-card border-0">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">Next Appointments</h5>
                <a class="btn btn-sm btn-outline-primary" asp-area="Doctors" asp-controller="Appointments" asp-action="Index">Manage</a>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Patient</th>
                            <th>Type</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (!upcoming.Any())
                        {
                            <tr>
                                <td colspan="4" class="text-muted">No upcoming appointments</td>
                            </tr>
                        }
                        else
                        {
                            foreach (var a in upcoming)
                            {
                                <tr>
                                    <td>@a.AppointmentDate.ToString("ddd, dd MMM yyyy HH:mm")</td>
                                    <td>@(string.IsNullOrWhiteSpace(a.PatientDisplayName) ? a.PatientKey : a.PatientDisplayName)</td>
                                    <td>@a.AppointmentType</td>
                                    <td><span class="badge bg-primary">Booked</span></td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


